<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>Paste</title>
<style>
body {
	padding: 0;
	margin: 0;
	width: 100%;
	height: 100vh;
	background-color: white;
	color: black;
}
@media (prefers-color-scheme: dark) {
	body {
		background-color: black;
		color: white;
	}
}
#main {
	width: 100%;
	height: 100%;
	padding: 1em;
	font-family: monospace;
	box-sizing: border-box;
	white-space: pre;
}
</style>
</head>
<body>
<div id=main contenteditable="true"></div>
<script>
var d = {
	version: 0,
	content: ''
};

async function sync() {
	let div = document.getElementById('main');
	let content = div.innerHTML;
	let dd = d;
	if (content != dd.content ) {
		dd.version = Math.floor(Date.now() / 1000);
		dd.content = content;
	}
	let dp = await fetch('/v1/sync', {
		method: 'POST',
		body: JSON.stringify(d)
	});
	if (dp.status == 409) {
		let dj = await dp.json();
		d = dj;
		div.innerHTML = d.content;
		return;
	} else if (dp.status == 204) {
		d.content = dd.content;
		return;
	} else {
		alert(dp.statusText);
		return;
	}
}

setInterval(async () => {
	await sync();
}, 1000);

// https://stackoverflow.com/a/36168767/3628322
document.getElementById('main').addEventListener('keydown', async (e) => {
	if(e.keyCode == 9) {
		document.execCommand('insertHTML', false, '&#9;');
		e.preventDefault();
	}
});

</script>
</body>
</html>
